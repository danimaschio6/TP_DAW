<!-- responder-encuesta.component.html -->
<div class="container-fluid py-4">
  
  <!-- Loading Spinner -->
  <div *ngIf="cargando()" class="d-flex justify-content-center align-items-center" style="min-height: 400px;">
    <p-progressSpinner ariaLabel="Cargando encuesta..."></p-progressSpinner>
  </div>

  <!-- Formulario de Encuesta -->
  <div *ngIf="!cargando() && encuesta()" class="row justify-content-center">
    <div class="col-12 col-lg-8">
      
      <!-- Título de la Encuesta -->
      <p-card>
        <ng-template pTemplate="header">
          <div class="text-center py-3">
            <h2 class="mb-0">{{ encuesta()?.nombre }}</h2>
            <p class="text-muted mt-2">Por favor responda todas las preguntas</p>
          </div>
        </ng-template>

        <!-- Formulario -->
        <form [formGroup]="form" (ngSubmit)="enviarRespuesta()" *ngIf="form">
          
          <!-- Iterar sobre preguntas -->
          <div *ngFor="let pregunta of encuesta()?.preguntas; let i = index" class="mb-4">
            
            <p-divider *ngIf="i > 0"></p-divider>
            
            <!-- Número y texto de pregunta -->
            <div class="mb-3">
              <h5 class="mb-2">
                <span class="badge bg-primary rounded-pill me-2">{{ pregunta.numero }}</span>
                {{ pregunta.texto }}
              </h5>
            </div>

            <!-- PREGUNTA ABIERTA -->
            <div *ngIf="esPreguntaAbierta(pregunta)" class="mb-3">
              <p-floatLabel>
                <textarea 
                  pInputTextarea 
                  [id]="'pregunta_' + pregunta.id"
                  [formControlName]="'pregunta_' + pregunta.id"
                  rows="4" 
                  cols="50"
                  class="w-100"
                  [class.is-invalid]="obtenerControlPregunta(pregunta.id).invalid && obtenerControlPregunta(pregunta.id).touched">
                </textarea>
                <label [for]="'pregunta_' + pregunta.id">Escriba su respuesta aquí...</label>
              </p-floatLabel>
              
              <!-- Error para pregunta abierta -->
              <app-texto-error 
                *ngIf="obtenerControlPregunta(pregunta.id).invalid && obtenerControlPregunta(pregunta.id).touched"
                [errors]="obtenerControlPregunta(pregunta.id).errors">
              </app-texto-error>
            </div>

            <!-- PREGUNTA SELECCIÓN SIMPLE (Radio Buttons) -->
            <div *ngIf="esPreguntaSeleccionSimple(pregunta)" class="mb-3">
              <div *ngFor="let opcion of pregunta.opciones" class="mb-2">
                <div class="d-flex align-items-center">
                  <p-radioButton 
                    [inputId]="'pregunta_' + pregunta.id + '_opcion_' + opcion.id"
                    [name]="'pregunta_' + pregunta.id"
                    [value]="opcion.id"
                    [formControlName]="'pregunta_' + pregunta.id">
                  </p-radioButton>
                  <label 
                    [for]="'pregunta_' + pregunta.id + '_opcion_' + opcion.id"
                    class="ms-2 cursor-pointer">
                    {{ opcion.texto }}
                  </label>
                </div>
              </div>
              
              <!-- Error para selección simple -->
              <app-texto-error 
                *ngIf="obtenerControlPregunta(pregunta.id).invalid && obtenerControlPregunta(pregunta.id).touched"
                [errors]="obtenerControlPregunta(pregunta.id).errors">
              </app-texto-error>
            </div>

            <!-- PREGUNTA SELECCIÓN MÚLTIPLE (Checkboxes) -->
            <div *ngIf="esPreguntaSeleccionMultiple(pregunta)" class="mb-3">
              <div *ngFor="let opcion of pregunta.opciones; let j = index" class="mb-2">
                <div class="d-flex align-items-center">
                  <p-checkbox 
                    [inputId]="'pregunta_' + pregunta.id + '_opcion_' + opcion.id"
                    [formControlName]="j"
                    [binary]="true">
                  </p-checkbox>
                  <label 
                    [for]="'pregunta_' + pregunta.id + '_opcion_' + opcion.id"
                    class="ms-2 cursor-pointer">
                    {{ opcion.texto }}
                  </label>
                </div>
              </div>

              <!-- Error para selección múltiple -->
              <app-texto-error 
                *ngIf="obtenerArrayControlPregunta(pregunta.id).invalid && obtenerArrayControlPregunta(pregunta.id).touched"
                [errors]="obtenerArrayControlPregunta(pregunta.id).errors">
              </app-texto-error>
            </div>

          </div>

          <!-- Botón Enviar -->
          <p-divider></p-divider>
          
          <div class="text-center mt-4">
            <p-button 
              type="submit"
              label="Enviar Respuestas"
              icon="pi pi-send"
              [disabled]="form.invalid || enviando()" 
              [loading]="enviando()"
              size="large"
              class="px-4">
            </p-button>
          </div>

        </form>

      </p-card>

    </div>
  </div>

  <!-- Estado de error -->
  <div *ngIf="!cargando() && !encuesta()" class="row justify-content-center">
    <div class="col-12 col-md-6 text-center">
      <p-card>
        <div class="py-4">
          <i class="pi pi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
          <h4 class="mt-3">Encuesta no encontrada</h4>
          <p class="text-muted">La encuesta que busca no existe o no está disponible.</p>
          <p-button 
            label="Volver al inicio" 
            icon="pi pi-home"
            (onClick)="router.navigateByUrl('/')">
          </p-button>
        </div>
      </p-card>
    </div>
  </div>

</div>